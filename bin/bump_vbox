#!/bin/sh

kernels="2.6.36-sabayon 2.6.37-sabayon 2.6.38-sabayon 2.6.39-sabayon 3.0.0-fusion"
running_kernel="3.0.0-sabayon"
packages="app-emulation/virtualbox-guest-additions app-emulation/virtualbox-modules x11-drivers/xf86-video-virtualbox"
non_tagged_packages="virtualbox-bin"

# build for latest kernel
KERNEL_DIR="/usr/src/linux-${running_kernel}" emerge $packages ${non_tagged_packages}
echo -5 | etc-update
eit add ${packages} ${non_tagged_packages}

for kernel in $kernels; do
        if [ "${kernel}" = "${running_kernel}" ]; then
                continue
        fi
        rm -rf /usr/portage/packages/*
        KERNEL_DIR="/usr/src/linux-${kernel}" emerge -B ${packages} || ( echo "ouch unable to build" && exit 1 )
        built_pkgs=$(find /usr/portage/packages -name "*.tbz2" | xargs echo)
        [[ -z "${built_pkgs}" ]] && echo "ouch no kernel pkgs" && exit 2
        eit fit ${built_pkgs} || ( echo "ouch unable to inject" && exit 3 )
        echo
        eit search "#${kernel}" -qv | sort | uniq
        echo
done

echo "Now you should remove old packages"
echo "PLEASE also see /etc/entropy/packages/packages.server.dep_rewrite"
